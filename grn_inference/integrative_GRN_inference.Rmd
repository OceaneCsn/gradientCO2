---
title: "Integrative GRN inference for the CO2 gradient dataset"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source('../inference_functions/bRF.R')
source('../inference_functions/LASSO-D3S.R')
source('../inference_functions/evaluateNetwork.R')
source('../inference_functions/MSE.R')
```

This document demonstrates the use of the bRF and LASSO-D3S functions for integrative GRN inference.

Those functions infer the regulatory pathways of *Arabidopsis thaliana*'s roots in response CO2.

They use as inputs the expression profiles of N-responsive genes and TFBS information. 
Prior TFBS information was built by searching in the promoters of the N-responsive genes the PWM of the N-responsive regulators. 

## Data import

### Expression data

Import of the expression data and the N-responsive genes and regulators :

```{r}
load('../rdata/CO2_degs_expression.rdata')
genes <- CO2_responsive_genes$genes
tfs <- CO2_responsive_genes$tfs
counts <- CO2_responsive_genes$counts
```

### TFBS data


```{r}
load("../rdata/pwm_occurrences_CO2_response.rdata")
dim(pwm_occurrence)
```

## GRN inference


### bRf : biased Random Forests

Let's infer a GRN using bRF with $\alpha=1$ and $D = 0.005$.
These values, especially $\alpha$; are derived from the manuscript presenting bRF.

```{r}
networks <- list()
for(alpha in seq(0, 1, by = 0.2)){
  importances <- bRF_inference(counts, genes, tfs, alpha = alpha, 
                             pwm_occurrence = pwm_occurrence, nCores = 40)
  for(density in c(0.001,0.005,0.01)){
    grn_bRF <- bRF_network(importances, density =density, pwm_occurrence, genes, tfs)
    networks[[paste0(alpha, '_', density)]] <- grn_bRF
  }
}

```


<!-- ### LASSO-D3S : LASSO with Differential Shrinkage and Stability Selection -->

<!-- Let's infer a GRN using LASSO-D3S with $\alpha=0.8$ and $D = 0.01$. -->

<!-- ```{r} -->
<!-- pvalues <- LASSO.D3S_inference(counts, genes, tfs, alpha = 0.8, N = 50, -->
<!--                                pwm_occurrence = pwm_occurrence, nCores = 50) -->
<!-- grn_lasso.d3s <- LASSO.D3S_network(pvalues, density = 0.005, pwm_occurrence, genes, tfs) -->
<!-- head(grn_lasso.d3s); dim(grn_lasso.d3s) -->
<!-- ``` -->


### Validating the GRNs against ConnecTF

```{r}
connecTF_validation <- evaluate_networks(networks, 
                  input_genes = genes, input_tfs = tfs, nCores = 40); connecTF_validation

connecTF_validation %>%
  separate(col = network_name, into = c("alpha", "density"), sep = '_') %>%
  ggplot(aes(x=alpha, y=precision, col = density)) +geom_smooth() + geom_point()

connecTF_validation %>%
  separate(col = network_name, into = c("alpha", "density"), sep = '_') %>%
  ggplot(aes(x=alpha, y=recall, col = density)) +geom_smooth() + geom_point()
```


# Inference of the final GRN

```{r}
importances <- bRF_inference(counts, genes, tfs, alpha = 1, 
                             pwm_occurrence = pwm_occurrence, nCores = 40)
grn_bRF <- bRF_network(importances, density = 0.005, pwm_occurrence, genes, tfs)
```

### Computing prediction error

```{r}
get_MSE(grn_bRF, method = "bRF")
```

The error in predicting the target gene expression is however lower in LASSO-D3S.

