---
title: "Integrative GRN inference for the CO2 gradient dataset"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(igraph)
library(patchwork)
library(DIANE)
library(ggpubr)
library(gridExtra)
# custom scripts for GRN inference
source('../inference_functions/bRF.R')
source('../inference_functions/LASSO-D3S.R')
source('../inference_functions/evaluateNetwork.R')
source('../inference_functions/MSE.R')
source('../grn_inference/rank_nodes.R')
```

This document demonstrates the use of the bRF and LASSO-D3S functions for integrative GRN inference.

Those functions infer the regulatory pathways of *Arabidopsis thaliana*'s roots in response to CO2 in a combinatorial design (CO2 * Nitrate supply).

It is meant to infer a new network with this new method, and compare it to the network previously inferred by the DIANE suite. 
Are the candidate regulators in those networks the same?

They use as inputs the expression profiles of CO2-responsive genes under low N and TFBS information. 
Prior TFBS information was built by searching in the promoters of the CO2-responsive genes the PWM of the CO2-responsive regulators. 

## Data import

### Expression data

Here we restrict ourselves to the study of genes responding to CO2, and only under KNO3 nutrition.
Import of the expression data and the N-responsive genes and regulators :

```{r}
load('../rdata/CO2combi_degs_expression.rdata')
genes <- CO2_responsive_genes$genes
tfs <- CO2_responsive_genes$tfs
counts <- CO2_responsive_genes$counts
```

### TFBS data


```{r}
load("../rdata/pwm_occurrences_CO2_response.rdata")
dim(pwm_occurrence)
```

## GRN inference

### Quick parametric exploration to find optimal $\alpha$ and $k$.

Let's infer a GRN using bRF with $\alpha=1$ and $D = 0.005$.
These values, especially $\alpha$; are derived from the manuscript presenting bRF.

```{r}

get_alpha_exploration <- function(){
  networks <- list()
  for(alpha in seq(0, 1, by = 0.1)){
  
    for(rep in 1:3){
      importances <- bRF_inference(counts, genes, tfs, alpha = alpha,
                                 prior_strength = 1,
                                 pwm_occurrence = pwm_occurrence, nCores = 50)
  
      for(density in c(0.001, 0.0025, 0.005, 0.01)){
  
      grn_bRF <- bRF_network(importances, density =density, pwm_occurrence, genes, tfs)
      networks[[paste0(rep,'_', alpha, '_', density)]] <- grn_bRF
    }
    }
  }
}

# networks <- get_alpha_exploration()
# networks <- networks[str_detect(names(networks), "0.005")]
# save(networks, file = "parameter_exploration.rdata")

load("parameter_exploration.rdata")
edges_num <- lapply(networks, function(df) df[sapply(df, is.numeric)])
d <- data.frame(name = names(unlist(lapply(edges_num, FUN = nrow))),
                 pwm = unlist(lapply(edges_num, FUN = colMeans)))
```

### Validating the GRNs against ConnecTF

```{r}
connecTF_validation <- evaluate_networks(networks, 
                  input_genes = genes, input_tfs = tfs, nCores = 40); connecTF_validation


target_validation <- evaluate_networks(networks, validation = c("TARGET"),
                  input_genes = genes, input_tfs = tfs, nCores = 40); connecTF_validation
fig <- d%>%
  separate(col = name, into = c("rep", "alpha", "density"), sep = '_') %>%
  filter(density==0.005) %>%
  mutate(density = str_remove(density,"\\.pwm")) %>%
  mutate(alpha = as.numeric(alpha)) %>%
  ggplot(aes(x=alpha, y=pwm, col = density, fill = density)) +geom_smooth() + 
  geom_point() + theme_pubr(legend = 'none') + ylab("PWM support") +
  scale_color_brewer(palette = "Set2")+
  scale_fill_brewer(palette = "Set2") + xlab(expression(alpha))+
connecTF_validation%>%
  separate(col = network_name, into = c("rep", "alpha", "density"), sep = '_') %>%
  filter(density==0.005) %>%
    mutate(alpha = as.numeric(alpha)) %>%
  ggplot(aes(x=alpha, y=precision, col = density, fill = density)) +
  geom_point() + theme_pubr() + geom_smooth() + 
  scale_color_brewer(palette = "Set2")+
  scale_fill_brewer(palette = "Set2")+ xlab(expression(alpha))+
connecTF_validation%>%
  separate(col = network_name, into = c("rep", "alpha", "density"), sep = '_') %>%
  filter(density==0.005) %>%
    mutate(alpha = as.numeric(alpha)) %>%
  mutate(density = str_remove(density,"\\.pwm")) %>%
  ggplot(aes(x=alpha, y=recall, col = density, fill = density)) +
  geom_point() + theme_pubr(legend = 'none') + geom_smooth() + 
  scale_color_brewer(palette = "Set2")+
  scale_fill_brewer(palette = "Set2")+ xlab(expression(alpha)) +
  plot_annotation(tag_levels = 'a', title = "PWM support, precision and recall for bRF as a function of TFBS contribution")


ggexport(fig, filename = "../results/alpha_exploration_grn.pdf", width = 11, height = 5)
```